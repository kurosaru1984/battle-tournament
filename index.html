<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æœ€å¼·ãƒãƒˆãƒ«ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆ2025 - ver 1.7</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #111;
      color: #f8f8f8;
      font-family: 'Arial', sans-serif;
      text-align: center;
      padding: 2rem;
    }
    .btn {
      background: #facc15;
      color: #000;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-weight: bold;
      margin: 0.5rem;
      cursor: pointer;
    }
    .log {
      background: #222;
      border: 2px solid #333;
      padding: 1rem;
      max-width: 700px;
      margin: 1rem auto;
      text-align: left;
      border-radius: 10px;
      white-space: pre-wrap;
    }
    .gallery img {
      max-width: 120px;
      margin: 0.5rem;
      border: 3px solid #f87171;
      border-radius: 10px;
      box-shadow: 0 0 10px #f87171;
    }
  </style>
</head>
<body>
  <h1 class="text-2xl font-bold text-yellow-400">ğŸ® æœ€å¼·ãƒãƒˆãƒ«ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆ2025</h1>
  <p class="text-gray-400 mb-4">ver 1.7</p>

  <button class="btn" onclick="startBGM()">ğŸµ BGMå†ç”Ÿ</button>
  <button class="btn" onclick="stopBGM()">ğŸ”‡ BGMåœæ­¢</button>
  <audio id="bgm" loop>
    <source src="./Peritune_Swift_Strike_loop.mp3" type="audio/mpeg">
  </audio>
  <div class="my-4">
    <select id="nameCategory" class="text-black">
      <option value="A">A</option>
      <option value="B">B</option>
      <option value="D">D</option>
    </select>
    <button class="btn" onclick="generateName()">ğŸ² åå‰ç”Ÿæˆ</button>
    <input id="playerName" class="text-black p-2" placeholder="ç”Ÿæˆã•ã‚ŒãŸåå‰" />
  </div>

  <div class="my-4">
    <button class="btn" onclick="startCamera()">ğŸ“¸ ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•</button>
    <video id="video" autoplay playsinline class="hidden border-4 border-yellow-500 mt-4"></video>
    <button id="takePhoto" class="btn hidden mt-2" onclick="takePhoto()">ğŸ–¼ï¸ å†™çœŸã‚’æ’®ã‚‹</button>
  </div>
  <div class="my-2">
    <label for="nameCategory" class="mr-2">åå‰ã‚«ãƒ†ã‚´ãƒª</label>
    <select id="nameCategory" class="text-black p-1">
      <option value="A">A</option>
      <option value="B">B</option>
      <option value="D">D</option>
    </select>
  </div>

  <canvas id="canvas" class="hidden"></canvas>
  <button id="confirmBtn" class="btn hidden" onclick="confirmPhoto()">âœ… ã“ã®ç”»åƒã‚’ä½¿ã†</button>

  <h2 class="text-xl mt-8 text-blue-300">ç™»éŒ²é¸æ‰‹ã‚®ãƒ£ãƒ©ãƒªãƒ¼</h2>
  <div id="gallery" class="gallery flex flex-wrap justify-center"></div>

  <div class="mt-10">
    <button class="btn" onclick="startBattle()">ğŸ¥Š ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆé–‹å§‹</button>
  </div>
  <div id="log" class="log"></div>

<script src="./name-data/setA.js"></script>
  <script>
    const bgm = document.getElementById('bgm');
    function startBGM() { bgm.currentTime = 0; bgm.play().catch(e => console.log(e)); }
    function stopBGM() { bgm.pause(); }

    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const takeBtn = document.getElementById('takePhoto');
    const confirmBtn = document.getElementById('confirmBtn');
    const ctx = canvas.getContext('2d');
    const gallery = document.getElementById('gallery');
    const log = document.getElementById('log');

    let players = [];
    let playerCount = 0;
    function generateName() {
      var category = document.getElementById("nameCategory").value;
      var data;
      if (category === "A") data = window.nameDataA;
      else if (category === "B") data = window.nameDataB;
      else if (category === "D") data = window.nameDataD;
      if (!data || !data.adjectives || !data.nouns || !data.titles) {
        console.warn("åå‰ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“", category);
        document.getElementById("playerName").value = "";
        return "";
      }
      function rand(arr){ return arr[Math.floor(Math.random() * arr.length)]; }
      var name = rand(data.adjectives) + rand(data.nouns) + rand(data.titles);
      document.getElementById("playerName").value = name;
      return name;
    }


    async function startCamera() {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { exact: 'environment' } } });
      video.srcObject = stream;
      video.classList.remove('hidden');
      takeBtn.classList.remove('hidden');
    }


    function takePhoto() {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0);
      canvas.classList.remove('hidden');
      confirmBtn.classList.remove('hidden');
    }

    function getRandom(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }

    function generateName() {
      const category = document.getElementById('nameCategory').value;
      let data;
      if (category === 'A') data = window.nameDataA;
      else if (category === 'B') data = window.nameDataB;
      else if (category === 'D') data = window.nameDataD;

      if (!data) {
        console.error('No name data for category:', category);
        return 'åç„¡ã—ã®æˆ¦å£«';
      }

      const adjective = getRandom(data.adjectives);
      const noun = getRandom(data.nouns);
      const title = getRandom(data.titles);
      return adjective + noun + title;
    }

    function confirmPhoto() {
      playerCount++;
      const dataUrl = canvas.toDataURL('image/png');
      const img = document.createElement('img');
      img.src = dataUrl;
      const name = generateName();
      img.alt = name;
      gallery.appendChild(img);
      players.push({ no: playerCount, img: dataUrl, name });
      canvas.classList.add('hidden');
      confirmBtn.classList.add('hidden');

    }

    function getRandomPair() {
      const shuffled = [...players].sort(() => 0.5 - Math.random());
      return [shuffled[0], shuffled[1]];
    }

    async function startBattle() {
      if (players.length < 2) {
        log.innerHTML = "âš ï¸ é¸æ‰‹ã¯æœ€ä½2äººç™»éŒ²ã—ã¦ãã ã•ã„ï¼";
        return;
      }

      const [a, b] = getRandomPair();
      log.innerHTML = `<strong>å¯¾æˆ¦ã‚«ãƒ¼ãƒ‰:</strong> ${a.name} vs ${b.name}<br>ğŸ“¡ å®Ÿæ³ç”Ÿæˆä¸­...`;

      try {
        const res = await fetch("/.netlify/functions/generateBattle", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ charA: a.name, charB: b.name })
        });

        const data = await res.json();

        if (data.result && typeof data.result === "string") {
          log.innerHTML += `\n\n<strong>ğŸ§  å®Ÿæ³çµæœ:</strong><br>${data.result}`;
        } else {
          log.innerHTML += `\nâš ï¸ è¿”ã£ã¦ããŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«å®Ÿæ³ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“<br><code>${JSON.stringify(data)}</code>`;
        }
      } catch (err) {
        log.innerHTML += `\nâŒ fetchè‡ªä½“ã«å¤±æ•—ã—ã¾ã—ãŸï¼š${err.message}<br><code>${JSON.stringify(err)}</code>`;
      }
    }
  </script>
  <script src="./name-data/setA.js"></script>
  <script src="./name-data/setB.js"></script>
  <script src="./name-data/setD.js"></script>
</body>
</html>
