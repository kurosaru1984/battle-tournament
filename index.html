<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>最強バトルトーナメント2025 - ver 2.0</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #111;
      color: #f8f8f8;
      font-family: 'Arial', sans-serif;
      text-align: center;
      padding: 2rem;
    }
    .btn {
      background: #facc15;
      color: #000;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-weight: bold;
      margin: 0.5rem;
      cursor: pointer;
    }
    .log {
      background: #222;
      border: 2px solid #333;
      padding: 1rem;
      max-width: 700px;
      margin: 1rem auto;
      text-align: left;
      border-radius: 10px;
      white-space: pre-wrap;
    }
    .gallery img {
      max-width: 120px;
      margin: 0.5rem;
      border: 3px solid #f87171;
      border-radius: 10px;
      box-shadow: 0 0 10px #f87171;
      cursor: pointer;
    }
    .gallery .player-container {
      margin: 0.5rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
    }
    .gallery .player-container input {
      margin-top: 0.25rem;
      max-width: 120px;
    }
    .gallery img.selected {
      border-color: #34d399;
      box-shadow: 0 0 10px #34d399;
    }
    .badge {
      position: absolute;
      top: 2px;
      right: 2px;
      background: #34d399;
      color: #000;
      font-size: 0.75rem;
      padding: 0 4px;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <h1 class="text-2xl font-bold text-yellow-400">🎮 最強バトルトーナメント2025</h1>
  <p class="text-gray-400 mb-4">ver 2.0</p>

  <button class="btn" onclick="startBGM()">🎵 BGM再生</button>
  <button class="btn" onclick="stopBGM()">🔇 BGM停止</button>
  <audio id="bgm" loop>
    <source src="./Peritune_Swift_Strike_loop.mp3" type="audio/mpeg">
  </audio>


  <div class="my-4">
    <button class="btn" onclick="startCamera()">📸 カメラを起動</button>
    <video id="video" autoplay playsinline class="hidden border-4 border-yellow-500 mt-4"></video>
    <button id="takePhoto" class="btn hidden mt-2" onclick="takePhoto()">🖼️ 写真を撮る</button>
  </div>

  <canvas id="canvas" class="hidden"></canvas>
  <button id="confirmBtn" class="btn hidden" onclick="confirmPhoto()">✅ この画像を使う</button>

  <div id="nameSection" class="my-4 hidden">
    <button id="generateImageBtn" class="btn mb-2" onclick="generateAIImage()">画像を生成</button>
    <button class="btn" onclick="generateName()">🎲 名前を生成</button>
    <input id="playerName" class="text-black p-2" placeholder="生成された名前" />
    <button class="btn" onclick="registerPlayer()">✅ 確定して登録</button>
  </div>

  <h2 class="text-xl mt-8 text-blue-300">登録選手ギャラリー</h2>
  <div id="gallery" class="gallery flex flex-wrap justify-center"></div>

  <div class="mt-10">
    <button class="btn" onclick="startBattle()">🥊 トーナメント開始</button>
  </div>
  <div id="log" class="log"></div>


<script src="./name-data/setA.js"></script>

  <script>
    const bgm = document.getElementById('bgm');
    function startBGM() { bgm.currentTime = 0; bgm.play().catch(e => console.log(e)); }
    function stopBGM() { bgm.pause(); }

    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const takeBtn = document.getElementById('takePhoto');
    const confirmBtn = document.getElementById('confirmBtn');
    const nameSection = document.getElementById('nameSection');
    const generateBtn = document.getElementById('generateImageBtn');
    const playerNameInput = document.getElementById('playerName');
    const ctx = canvas.getContext('2d');
    const gallery = document.getElementById('gallery');
    const log = document.getElementById('log');

    let players = [];
    let playerCount = 0;
    let originalImage = null;
    let currentImage = null;

    async function startCamera() {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { exact: 'environment' } } });
      video.srcObject = stream;
      video.classList.remove('hidden');
      takeBtn.classList.remove('hidden');
    }


    function takePhoto() {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0);
      canvas.classList.remove('hidden');
      confirmBtn.classList.remove('hidden');
    }

    function getRandom(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }

    let prevAdj="", prevNoun="", prevTitle="";
    function getRandomDifferent(arr, prev){
      let v;
      do { v = arr[Math.floor(Math.random()*arr.length)]; } while(arr.length>1 && v===prev);
      return v;
    }
    function generateName() {
      const data = window.nameDataA;
      const adjective = getRandomDifferent(data.adjectives, prevAdj);
      const noun = getRandomDifferent(data.nouns, prevNoun);
      const title = getRandomDifferent(data.titles, prevTitle);
      prevAdj = adjective;
      prevNoun = noun;
      prevTitle = title;
      const name = adjective + noun + title;
      playerNameInput.value = name;
      return name;
    }


    function confirmPhoto() {
      originalImage = canvas.toDataURL('image/png');
      currentImage = originalImage;
      confirmBtn.classList.add('hidden');
      takeBtn.classList.add('hidden');
      if (video.srcObject) {
        video.srcObject.getTracks().forEach(t => t.stop());
      }
      video.classList.add('hidden');
      nameSection.classList.remove('hidden');
      generateBtn.classList.remove('hidden');
    }

    async function generateAIImage() {
      if (canvas.classList.contains('hidden')) return;
      const dataURL = canvas.toDataURL('image/png');
      generateBtn.disabled = true;
      const prevText = generateBtn.textContent;
      generateBtn.textContent = '生成中...';
      try {
        const res = await fetch('/.netlify/functions/generateImage', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ imageData: dataURL })
        });
        const data = await res.json();
        if (data.generatedImage) {
          currentImage = data.generatedImage;
          const img = new Image();
          img.onload = () => {
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
          };
          img.src = currentImage;
        }
      } catch (e) {
        console.error(e);
      } finally {
        generateBtn.disabled = false;
        generateBtn.textContent = prevText;
      }
    }

    function registerPlayer() {
      const name = playerNameInput.value || generateName();
      if (!originalImage || !currentImage) return;
      playerCount++;
      players.push({ no: playerCount, name, img: originalImage, generatedImg: currentImage });
      const playerIndex = players.length - 1;
      const container = document.createElement('div');
      container.className = 'player-container';
      const img = document.createElement('img');
      img.src = players[playerIndex].generatedImg || players[playerIndex].img;
      img.alt = name;
      if (players[playerIndex].generatedImg && players[playerIndex].generatedImg !== players[playerIndex].img) {
        const badge = document.createElement('div');
        badge.textContent = '生成済';
        badge.className = 'badge';
        container.appendChild(badge);
      }
      const regen = document.createElement('button');
      regen.textContent = '画像を再生成';
      regen.className = 'btn mt-1';
      regen.addEventListener('click', () => regenerateImage(playerIndex, img, container));
      const input = document.createElement('input');
      input.type = 'text';
      input.value = name;
      input.className = 'mt-1 px-2 py-1 rounded text-black text-center';
      input.addEventListener('input', (e) => {
        players[playerIndex].name = e.target.value;
      });
      container.appendChild(img);
      container.appendChild(regen);
      container.appendChild(input);
      gallery.appendChild(container);
      playerNameInput.value = '';
      nameSection.classList.add('hidden');
      canvas.classList.add('hidden');
      generateBtn.classList.add('hidden');
      log.innerHTML = `✅ ${name} を登録しました！`;
      currentImage = null;
      originalImage = null;
    }

    async function regenerateImage(index, imgEl, container) {
      try {
        const res = await fetch('/.netlify/functions/generateImage', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ imageData: players[index].img })
        });
        const data = await res.json();
        if (data.generatedImage) {
          players[index].generatedImg = data.generatedImage;
          imgEl.src = data.generatedImage;
          if (!container.querySelector('.badge')) {
            const badge = document.createElement('div');
            badge.textContent = '生成済';
            badge.className = 'badge';
            container.appendChild(badge);
          }
        }
      } catch (e) {
        console.error(e);
      }
    }

    function getRandomPair(list) {
      const shuffled = [...list].sort(() => 0.5 - Math.random());
      return [shuffled[0], shuffled[1]];
    }

    async function startBattle() {
      const readyPlayers = players.filter(p => p.name);
      if (readyPlayers.length < 2) {
        log.innerHTML = "⚠️ 名前登録済みの選手を最低2人用意してください！";
        return;
      }

      const [a, b] = getRandomPair(readyPlayers);
      log.innerHTML = `<strong>対戦カード:</strong> ${a.name} vs ${b.name}<br>📡 実況生成中...`;

      try {
        const res = await fetch("/.netlify/functions/generateBattle", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ charA: a.name, charB: b.name })
        });

        const data = await res.json();

        if (data.result && typeof data.result === "string") {
          log.innerHTML += `\n\n<strong>🧠 実況結果:</strong><br>${data.result}`;
        } else {
          log.innerHTML += `\n⚠️ 返ってきたレスポンスに実況が含まれていません<br><code>${JSON.stringify(data)}</code>`;
        }
      } catch (err) {
        log.innerHTML += `\n❌ fetch自体に失敗しました：${err.message}<br><code>${JSON.stringify(err)}</code>`;
      }
    }
  </script>
</body>
</html>
